import feedparser
import os
import time
import requests
import smtplib
import urllib.parse
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from datetime import datetime

# --- CONFIGURATION ---

# 1. GENERAL SECTOR KEYWORDS (The "Wide Net")
GENERAL_KEYWORDS = [
    "NBFC", "Non-Banking Financial Company", "Shadow Bank", "Fintech Lender", 
    "Microfinance", "Housing Finance", "Gold Loan"
]

# 2. WATCHLIST (User List + Extracted from BCG Report)
# We split these into batches later to ensure Google doesn't block the long URL.
WATCHLIST_COMPANIES = [
    # User Specific
    "SBFC Finance", "Kogta Financial", "Bajaj Finance", "HDB Financial", "Tata Capital", 
    "Shriram Finance", "Sundaram Finance", "Poonawalla Fincorp", "Godrej Capital", 
    "Hero FinCorp", "Anand Rathi", "Piramal Capital", "Aditya Birla Capital", 
    "Cholamandalam Investment", "Mahindra Finance", "L&T Finance", "IIFL Finance", 
    "Capri Global", "Ugro Capital", "Clix Capital", "APC", 
    # From BCG Report (Housing, Gold, MFI, Cards)
    "LIC Housing Finance", "Repco Home Finance", "Can Fin Homes", "PNB Housing", 
    "GIC Housing", "IndoStar Capital", "Bajaj Housing Finance", "Samman Capital",
    "CreditAccess Grameen", "Satin Creditcare", "Asirvad Microfinance", 
    "Muthoot Finance", "Manappuram Finance", "SBI Card", "Spandana Sphoorty"
]

# 3. ACTION KEYWORDS (What are we looking for?)
ACTIONS = [
    "investment", "deal", "funding", "stake", "partnership", "tie-up", 
    "launch", "product", "appoint", "CEO", "MD", "resign", 
    "report", "outlook", "earnings", "profit", "quarter", "result", "Q3", "Q4"
]

# Priority Models
MODELS = [
    "gemini-2.5-flash",
    "gemini-2.5-flash-lite", 
    "gemini-2.0-flash",
    "gemini-1.5-flash"
]

# API Keys & Secrets
API_KEY = os.environ.get("GEMINI_API_KEY") or os.environ.get("GOOGLE_API_KEY")
EMAIL_USER = os.environ.get("EMAIL_USER")
EMAIL_PASS = os.environ.get("EMAIL_PASS")
EMAIL_RECEIVER = os.environ.get("EMAIL_RECEIVER")

def generate_rss_links():
    """
    Generates multiple RSS links to ensure we cover ALL companies without breaking
    Google's URL length limit.
    """
    links = []
    
    # Batch 1: General Sector News (The "Macro" view)
    # Query: (NBFC OR ...) AND (investment OR deal ...) AND India
    general_query = f"({' OR '.join(GENERAL_KEYWORDS)}) AND ({' OR '.join(ACTIONS)}) AND India when:1d"
    encoded_gen = urllib.parse.quote(general_query)
    links.append(f"https://news.google.com/rss/search?q={encoded_gen}&hl=en-IN&gl=IN&ceid=IN:en")

    # Batch 2 & 3: Specific Company News (The "Micro" view)
    # We split companies into chunks of 10 to keep URLs safe.
    chunk_size = 10
    for i in range(0, len(WATCHLIST_COMPANIES), chunk_size):
        chunk = WATCHLIST_COMPANIES[i:i + chunk_size]
        # Query: (Bajaj Finance OR Muthoot OR ...) AND India
        company_query = f"({' OR '.join(f'"{c}"' for c in chunk)}) AND India when:1d"
        encoded_co = urllib.parse.quote(company_query)
        links.append(f"https://news.google.com/rss/search?q={encoded_co}&hl=en-IN&gl=IN&ceid=IN:en")
        
    return links

def send_email(content):
    if not EMAIL_USER or not EMAIL_PASS or not EMAIL_RECEIVER:
        print("Skipping email: Missing secrets.")
        return

    try:
        msg = MIMEMultipart()
        msg['From'] = EMAIL_USER
        msg['To'] = EMAIL_RECEIVER
        msg['Subject'] = f"NBFC & Banking Ecosystem Update - {datetime.now().strftime('%d %b %Y')}"

        formatted_content = content.replace('\n', '<br>')

        html_content = f"""
        <html>
        <body style="font-family: 'Segoe UI', Arial, sans-serif; color: #333; line-height: 1.6;">
            <div style="max-width: 700px; margin: auto; border: 1px solid #ddd; padding: 20px; border-radius: 8px;">
                <h2 style="color: #004080; border-bottom: 3px solid #004080; padding-bottom: 10px;">
                    üáÆüá≥ Daily NBFC & Ecosystem Briefing
                </h2>
                <p style="font-size: 13px; color: #666;">
                    <strong>Date:</strong> {datetime.now().strftime('%d %B %Y')}<br>
                    <strong>Watchlist:</strong> {len(WATCHLIST_COMPANIES)} Companies (SBFC, Bajaj, Muthoot, Ugro, etc.)
                </p>
                <div style="background-color: #f9f9f9; padding: 15px; border-radius: 5px;">
                    {formatted_content} 
                </div>
                <p style="font-size: 11px; color: #888; margin-top: 20px;">
                    Generated by Gemini 2.5 Bot
                </p>
            </div>
        </body>
        </html>
        """
        msg.attach(MIMEText(html_content, 'html'))

        server = smtplib.SMTP('smtp.gmail.com', 587)
        server.starttls()
        server.login(EMAIL_USER, EMAIL_PASS)
        server.send_message(msg)
        server.quit()
        print(f"‚úÖ Executive Briefing sent to {EMAIL_RECEIVER}!")
    except Exception as e:
        print(f"‚ùå Failed to send email: {e}")

def analyze_market_news():
    print(f"Scanning news for {len(WATCHLIST_COMPANIES)} NBFCs + General Sector updates...")
    
    rss_links = generate_rss_links()
    all_headlines = []
    seen_titles = set()

    # Fetch from all generated RSS links
    for link in rss_links:
        feed = feedparser.parse(link)
        for entry in feed.entries:
            # Deduplication: Avoid processing the same story twice
            if entry.title not in seen_titles:
                all_headlines.append(f"- {entry.title} (Link: {entry.link})")
                seen_titles.add(entry.title)
    
    # Limit to top 40 most relevant to avoid token overflow, but since we are specific, 
    # we just take the first 40 unique ones found.
    final_headlines = all_headlines[:40]

    if not final_headlines:
        print("No news found today for the watchlist.")
        # Optional: Send an email saying "No news" if you want.
        return

    print(f"Found {len(final_headlines)} unique headlines. Generating Intelligence Report...")

    if not API_KEY:
        print("Error: API Key is missing.")
        return

    # --- THE "STRICT SECTIONS" PROMPT ---
    prompt_text = (
        "You are a Market Intelligence Analyst for an Indian NBFC. "
        "Review today's news and create a structured daily briefing. "
        "Focus strictly on the companies listed and the general Indian NBFC/Banking sector.\n\n"
        
        "**Strict Output Rules:**\n"
        "1. Categorize news into the 6 buckets below.\n"
        "2. **IF NO NEWS** is found for a specific category, you MUST write: *'No significant updates for today.'* under that header. Do NOT skip the header.\n"
        "3. Include the **(Link)** provided in the headline for every single news item.\n\n"
        
        "**Categories:**\n"
        "1. **üìä Earnings & Financials:** (Results, Profit, AUM, NPA, Outlook)\n"
        "2. **üí∞ Deals & Fundraising:** (Capital Raise, M&A, Stake Sales, Debt raise)\n"
        "3. **üìë Reports & Outlook:** (Brokerage notes, Rating changes, CRISIL/ICRA reports)\n"
        "4. **ü§ù Strategic Partnerships:** (Co-lending, Fintech tie-ups, Bank partnerships)\n"
        "5. **üöÄ Product & Business:** (New branches, App launches, New loan products)\n"
        "6. **üëî People & Regulation:** (CEO/CXO Hires/Exits, RBI Circulars)\n\n"

        "**Headlines:**\n"
        + "\n".join(final_headlines) + "\n\n"

        "**Format:** HTML-friendly markdown (Bold headers, bullet points)."
    )

    # --- THE DIRECT API LOOP ---
    success = False
    final
